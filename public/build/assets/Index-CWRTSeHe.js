import{u as Y,r as d,a as E,b as G,j as t,H as Z}from"./app-BCnxwFoh.js";import{A as K}from"./AdminLayout-COULfUu7.js";function re(){const{rates:A,defaultCurrency:n,availableMetals:J,metalSummaries:o,metalPurities:c}=Y().props,[y,L]=d.useState(null),[m,Q]=d.useState("all"),[V,S]=d.useState(0),I=d.useCallback((e,s)=>{try{return new Intl.NumberFormat("en-IN",{style:"currency",currency:s,maximumFractionDigits:2}).format(e)}catch{return`${e.toLocaleString("en-IN")} ${s}`}},[]),z=d.useCallback(e=>e?e.split(/[-_]/).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):null,[]),u=d.useCallback((e,s,r)=>r.length===0?e.length>0?e.map(a=>({purity:a.purity??"",price_per_gram:typeof a.price_per_gram=="number"&&!Number.isNaN(a.price_per_gram)?String(a.price_per_gram):""})):[{purity:"",price_per_gram:""}]:r.map(a=>{const l=e.find(i=>i.purity===a.name);return{purity:a.name,price_per_gram:l&&typeof l.price_per_gram=="number"&&!Number.isNaN(l.price_per_gram)?String(l.price_per_gram):""}}),[]),b=E({currency:o.gold?.latest?.currency??n,rates:u(o.gold?.rates??[],"gold",c.gold??[])}),v=E({currency:o.silver?.latest?.currency??n,rates:u(o.silver?.rates??[],"silver",c.silver??[])}),[k,j]=d.useState({});d.useEffect(()=>{const e={};Object.keys(o).forEach(s=>{if(s!=="gold"&&s!=="silver"){const r=o[s],a=c[s]??[];r?e[s]={currency:r.latest?.currency??n,rates:u(r.rates,s,a)}:a.length>0&&(e[s]={currency:n,rates:u([],s,a)})}}),j(s=>({...s,...e}))},[n,u,c,o]);const N=E({currency:n,rates:[{purity:"",price_per_gram:""}]}),P=d.useRef("");d.useEffect(()=>{if(m!=="all"&&m!=="gold"&&m!=="silver"){if(P.current!==m){const s=c[m]??[],r=k[m];if(r&&r.rates.length>0){const a=u(r.rates.map(l=>({purity:l.purity,price_per_gram:parseFloat(l.price_per_gram)||0,currency:r.currency})),m,s);N.setData("currency",r.currency),N.setData("rates",a)}else s.length>0&&(N.setData("currency",n),N.setData("rates",u([],m,s)));P.current=m}}else P.current=""},[m]);const h=d.useCallback(e=>e==="gold"?b:e==="silver"?v:N,[N,b,v]),B=d.useRef(!1),U=d.useRef(!1);d.useEffect(()=>{if(!B.current&&(o.gold||c.gold&&c.gold.length>0)){const e=c.gold??[];o.gold?(b.setData("currency",o.gold.latest?.currency??n),b.setData("rates",u(o.gold.rates,"gold",e))):e.length>0&&(b.setData("currency",n),b.setData("rates",u([],"gold",e))),B.current=!0}},[n,u,c.gold,o.gold]),d.useEffect(()=>{if(!U.current&&(o.silver||c.silver&&c.silver.length>0)){const e=c.silver??[];o.silver?(v.setData("currency",o.silver.latest?.currency??n),v.setData("rates",u(o.silver.rates,"silver",e))):e.length>0&&(v.setData("currency",n),v.setData("rates",u([],"silver",e))),U.current=!0}},[n,u,c.silver,o.silver]),d.useEffect(()=>{const e={};Object.keys(o).forEach(s=>{if(s!=="gold"&&s!=="silver"){const r=o[s],a=c[s]??[];r?e[s]={currency:r.latest?.currency??n,rates:u(r.rates,s,a)}:a.length>0?e[s]={currency:n,rates:u([],s,a)}:e[s]={currency:n,rates:[]}}}),j(s=>{const r={...s};return Object.keys(e).forEach(a=>{const l=c[a]??[];(!s[a]||s[a].rates.length===0&&l.length>0)&&(r[a]=e[a])}),r})},[n,u,c,o]);const $=d.useCallback((e,s,r,a)=>{if(e==="gold"||e==="silver"){const l=h(e),i=[...l.data.rates];i[s]={...i[s],[r]:a},l.setData("rates",i)}else j(l=>{const i=l[e]||{currency:n,rates:[]},p=[...i.rates];return p[s]={...p[s],[r]:a},{...l,[e]:{...i,rates:p}}});S(l=>l+1)},[n,h]),O=d.useCallback(e=>{const s=c[e]??[];if(e==="gold"||e==="silver"){const r=h(e),a=new Set(r.data.rates.map(i=>i.purity).filter(Boolean)),l=s.find(i=>!a.has(i.name));l?r.setData("rates",[...r.data.rates,{purity:l.name,price_per_gram:""}]):r.setData("rates",[...r.data.rates,{purity:"",price_per_gram:""}])}else j(r=>{const a=r[e]||{currency:n,rates:[]},l=new Set(a.rates.map(w=>w.purity).filter(Boolean)),i=s.find(w=>!l.has(w.name)),p=i?{purity:i.name,price_per_gram:""}:{purity:"",price_per_gram:""};return{...r,[e]:{...a,rates:[...a.rates,p]}}}),S(r=>r+1)},[n,h,c]),R=d.useCallback((e,s)=>{const r=c[e]??[];if(e==="gold"||e==="silver"){const a=h(e);if(r.length>0&&a.data.rates.length<=r.length&&new Set(a.data.rates.map(i=>i.purity).filter(Boolean)).size===r.length&&a.data.rates.length===r.length)return;if(a.data.rates.length===1){a.setData("rates",[{purity:"",price_per_gram:""}]);return}a.setData("rates",a.data.rates.filter((l,i)=>i!==s))}else j(a=>{const l=a[e]||{currency:n,rates:[]};return r.length>0&&l.rates.length<=r.length&&new Set(l.rates.map(p=>p.purity).filter(Boolean)).size===r.length&&l.rates.length===r.length?a:l.rates.length===1?{...a,[e]:{...l,rates:[{purity:"",price_per_gram:""}]}}:{...a,[e]:{...l,rates:l.rates.filter((i,p)=>p!==s)}}}),S(a=>a+1)},[n,h,c]),H=d.useCallback(e=>{if(e==="gold"||e==="silver")h(e).post(route("admin.rates.metal.store",{metal:e}),{preserveScroll:!0});else{const s=k[e]||{currency:n,rates:[]};G.post(route("admin.rates.metal.store",{metal:e}),{currency:s.currency,rates:s.rates},{preserveScroll:!0,onSuccess:()=>{S(r=>r+1)}})}},[n,k,h]),C=d.useCallback(e=>{L(e),G.post(route("admin.rates.sync",{metal:e}),{},{preserveScroll:!0,onFinish:()=>L(null)})},[]),T=d.useCallback(e=>{const s=o[e];if(!s)return null;const r=h(e),a=r.processing,l=s.latest;let i=[],p=n;if(e==="gold"||e==="silver")i=r.data.rates||[],p=r.data.currency||n;else{const f=k[e];if(f)i=f.rates||[],p=f.currency||n;else{const x=c[e]??[];x.length>0&&(i=u([],e,x))}}const w=r.errors;return t.jsxs("section",{className:"space-y-5 rounded-3xl bg-white p-6 shadow-xl shadow-slate-900/10 ring-1 ring-slate-200/80",children:[t.jsxs("header",{className:"flex flex-col gap-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsxs("h2",{className:"text-xl font-semibold text-slate-900",children:[s.label," reference rates"]}),t.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-slate-500",children:"Live reference & manual control"})]}),t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60",onClick:()=>C(e),disabled:y===e,children:[t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3.5 w-3.5",viewBox:"0 0 20 20",fill:"currentColor",children:[t.jsx("path",{fillRule:"evenodd",d:"M3.172 7a4 4 0 015.656-5.656l1.172 1.172a.75.75 0 101.06-1.06L9.89.516a5.5 5.5 0 00-7.778 7.778l.354.353a.75.75 0 001.06-1.06L3.172 7zm13.657 6a4 4 0 01-5.657 5.657l-1.172-1.172a.75.75 0 10-1.06 1.06l1.17 1.172a5.5 5.5 0 007.778-7.778l-.353-.354a.75.75 0 10-1.06 1.06l.354.355z",clipRule:"evenodd"}),t.jsx("path",{d:"M6.75 6.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5zM9.25 12a.75.75 0 01.75-.75h3a.75.75 0 010 1.5h-3a.75.75 0 01-.75-.75z"})]}),y===e?"Syncing…":`Sync ${s.label}`]})]}),l?t.jsxs("div",{className:"rounded-2xl border border-slate-100 bg-slate-50 p-4",children:[t.jsx("p",{className:"text-sm font-medium text-slate-600",children:"Latest live feed"}),t.jsxs("p",{className:"mt-2 text-2xl font-semibold text-slate-900",children:[I(l.price_per_gram,l.currency)," ",t.jsxs("span",{className:"text-base font-normal text-slate-500",children:["/ gram · ",l.purity??"—"]})]}),l.source&&t.jsx("p",{className:"mt-1 text-xs uppercase tracking-[0.2em] text-slate-400",children:z(l.source)}),l.effective_at&&t.jsxs("p",{className:"mt-1 text-xs uppercase tracking-[0.2em] text-slate-400",children:["Updated ",new Date(l.effective_at).toLocaleString("en-IN")]})]}):t.jsx("div",{className:"rounded-2xl border border-dashed border-slate-200 p-4 text-sm text-slate-500",children:"No live feed synced yet. Use the sync button to fetch reference rates."})]}),t.jsxs("div",{className:"space-y-4",children:[i.map((f,x)=>{const g=w[`rates.${x}.purity`],_=Array.isArray(g)?g[0]:g,M=w[`rates.${x}.price_per_gram`],q=Array.isArray(M)?M[0]:M,W=c[e]??[];return t.jsxs("div",{className:"rounded-2xl border border-slate-200 p-4",children:[t.jsxs("div",{className:"grid gap-4 sm:grid-cols-[1fr_auto]",children:[t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500",children:["Purity",t.jsx("input",{type:"text",value:f.purity,readOnly:!0,className:"rounded-2xl border border-slate-200 bg-slate-100 px-4 py-2 text-sm font-medium text-slate-600 cursor-not-allowed"})]}),_&&t.jsx("span",{className:"text-xs text-rose-500",children:_}),W.length===0&&t.jsx("span",{className:"text-xs text-amber-600",children:"No purities available for this metal. Please add purities in Metal Purities section."})]}),t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500",children:["Rate / gram",t.jsx("input",{type:"number",min:"0",step:"0.01",value:f.price_per_gram,onChange:D=>$(e,x,"price_per_gram",D.target.value),className:"rounded-2xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-800 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200",placeholder:"0.00"})]}),q&&t.jsx("span",{className:"text-xs text-rose-500",children:q})]})]}),t.jsxs("div",{className:"mt-3 flex justify-between text-xs text-slate-500",children:[t.jsx("span",{children:p?.toUpperCase()||n}),(()=>{const D=c[e]??[];if(D.length===0)return t.jsx("button",{type:"button",className:"text-rose-500 transition hover:text-rose-600",onClick:()=>R(e,x),children:"Remove"});const X=new Set(i.map(F=>F.purity).filter(Boolean));return!D.every(F=>X.has(F.name))||i.length>D.length?t.jsx("button",{type:"button",className:"text-rose-500 transition hover:text-rose-600",onClick:()=>R(e,x),children:"Remove"}):null})()]})]},`${f.purity}-${x}`)}),(()=>{const f=c[e]??[],x=new Set(i.map(_=>_.purity).filter(Boolean)),g=f.filter(_=>!x.has(_.name));return g.length>0?t.jsxs("button",{type:"button",onClick:()=>O(e),className:"inline-flex items-center gap-2 rounded-full border border-dashed border-slate-300 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-600 transition hover:border-slate-400 hover:text-slate-700",children:[t.jsx("span",{className:"text-lg leading-none",children:"+"})," Add purity (",g.length," available)"]}):null})()]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500",children:["Currency",t.jsx("input",{type:"text",value:p,onChange:f=>{const x=f.target.value.toUpperCase();e==="gold"||e==="silver"?r.setData("currency",x):(j(g=>({...g,[e]:{...g[e],currency:x,rates:g[e]?.rates||i}})),S(g=>g+1))},className:"w-28 rounded-2xl border border-slate-200 px-3 py-2 text-sm font-medium uppercase text-slate-800 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200",maxLength:10})]}),t.jsx("button",{type:"button",onClick:()=>H(e),disabled:a,className:"ml-auto inline-flex items-center gap-2 rounded-full bg-slate-900 px-5 py-2 text-sm font-semibold text-white shadow shadow-slate-900/30 transition hover:bg-slate-700 disabled:cursor-not-allowed disabled:opacity-60",children:a?"Saving…":"Save rates"})]})]})},[O,n,k,I,z,V,h,u,c,o,R,H,$,C,y]);return t.jsxs(K,{children:[t.jsx(Z,{title:"Live Rates"}),t.jsxs("div",{className:"space-y-8",children:[t.jsx("div",{className:"rounded-3xl bg-white p-6 shadow-xl shadow-slate-900/10 ring-1 ring-slate-200/80",children:t.jsxs("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-semibold text-slate-900",children:"Reference rates"}),t.jsx("p",{className:"text-sm text-slate-500",children:"Sync live values for metals and lock in your internal calculation rates."})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("button",{type:"button",onClick:()=>C("gold"),disabled:y==="gold",className:"inline-flex items-center gap-2 rounded-full bg-amber-500 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-amber-400 disabled:cursor-not-allowed disabled:opacity-60",children:y==="gold"?"Syncing…":"Sync gold rate"}),t.jsx("button",{type:"button",onClick:()=>C("silver"),disabled:y==="silver",className:"inline-flex items-center gap-2 rounded-full bg-slate-600 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-slate-500 disabled:cursor-not-allowed disabled:opacity-60",children:y==="silver"?"Syncing…":"Sync silver rate"})]})]})}),t.jsxs("div",{className:"rounded-3xl bg-white p-6 shadow-xl shadow-slate-900/10 ring-1 ring-slate-200/80",children:[t.jsx("div",{className:"mb-6",children:t.jsxs("label",{className:"flex flex-col gap-2 text-sm font-semibold text-slate-700",children:[t.jsx("span",{children:"Select Metal"}),t.jsxs("select",{value:m,onChange:e=>Q(e.target.value),className:"w-full max-w-xs rounded-2xl border border-slate-300 bg-white px-4 py-2.5 text-sm text-slate-900 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200",children:[t.jsx("option",{value:"all",children:"All Metals"}),J.map(e=>t.jsx("option",{value:e.value,children:e.name},e.id))]})]})}),m==="all"?t.jsx("div",{className:"grid gap-6 xl:grid-cols-2",children:Object.keys(o).map(e=>{const s=T(e);return s?t.jsx("div",{children:s},e):null})}):t.jsx("div",{children:T(m)})]}),t.jsx("div",{className:"overflow-hidden rounded-3xl bg-white shadow-xl shadow-slate-900/10 ring-1 ring-slate-200/80",children:t.jsxs("table",{className:"min-w-full divide-y divide-slate-200 text-sm",children:[t.jsx("thead",{className:"bg-slate-50 text-xs uppercase tracking-[0.3em] text-slate-500",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-5 py-3 text-left",children:"Metal"}),t.jsx("th",{className:"px-5 py-3 text-left",children:"Purity"}),t.jsx("th",{className:"px-5 py-3 text-right",children:"Price / g"}),t.jsx("th",{className:"px-5 py-3 text-left",children:"Source"}),t.jsx("th",{className:"px-5 py-3 text-left",children:"Effective at"}),t.jsx("th",{className:"px-5 py-3 text-left",children:"Notes"})]})}),t.jsxs("tbody",{className:"divide-y divide-slate-100 bg-white",children:[A.data.map(e=>t.jsxs("tr",{className:"hover:bg-slate-50",children:[t.jsx("td",{className:"px-5 py-3 font-semibold text-slate-900",children:e.metal}),t.jsx("td",{className:"px-5 py-3 text-slate-500",children:e.purity??"—"}),t.jsxs("td",{className:"px-5 py-3 text-right text-slate-900",children:[e.price_per_gram.toLocaleString("en-IN")," ",e.currency]}),t.jsx("td",{className:"px-5 py-3 text-slate-600",children:e.source}),t.jsx("td",{className:"px-5 py-3 text-slate-500",children:e.effective_at?new Date(e.effective_at).toLocaleString("en-IN"):"—"}),t.jsx("td",{className:"px-5 py-3 text-slate-500",children:typeof e.metadata?.notes=="string"&&e.metadata.notes.trim().length?e.metadata.notes:"—"})]},e.id)),A.data.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"px-5 py-6 text-center text-sm text-slate-500",children:"No rate records found."})})]})]})})]})]})}export{re as default};
